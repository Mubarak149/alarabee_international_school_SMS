{% extends 'base.html' %}
{% load static %}

{% block title %}Settings - School SMS{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'student_dashboard' %}">Home</a></li>
<li class="breadcrumb-item active">Settings</li>
{% endblock %}

{% block page_css %}
<style>
    /* Settings Page Styles */
    .settings-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    
    .settings-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 15px 20px;
        font-weight: 600;
        color: #495057;
    }
    
    .setting-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .setting-item:last-child {
        border-bottom: none;
    }
    
    .setting-info {
        flex: 1;
    }
    
    .setting-title {
        font-weight: 500;
        color: #495057;
        margin-bottom: 3px;
    }
    
    .setting-description {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .setting-value {
        color: #6c757d;
        font-weight: 500;
    }
    
    .disabled-setting {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    /* Toggle Switch */
    .form-check-input:checked {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .form-check-input:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
    }
    
    /* Save Button */
    .save-btn {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border: none;
        color: white;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 500;
        transition: transform 0.3s;
    }
    
    .save-btn:hover {
        transform: translateY(-2px);
        color: white;
        box-shadow: 0 5px 15px rgba(78, 115, 223, 0.4);
    }
    
    .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xl-8">
        <!-- Notification Settings -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-bell me-2"></i> Notification Settings
            </div>
            <div class="card-body p-0">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Email Notifications</div>
                        <div class="setting-description">Receive notifications about grades, assignments, and announcements via email</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="emailNotifications" checked>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">New Grade Alerts</div>
                        <div class="setting-description">Get notified when new grades are posted</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="gradeAlerts" checked>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Assignment Reminders</div>
                        <div class="setting-description">Remind me about upcoming assignment deadlines</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="assignmentReminders" checked>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Report Card Alerts</div>
                        <div class="setting-description">Notify me when new report cards are available</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="reportCardAlerts" checked>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Settings -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-lock me-2"></i> Privacy Settings
            </div>
            <div class="card-body p-0">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Show Profile to Classmates</div>
                        <div class="setting-description">Allow classmates to view your profile information</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="showProfile" checked>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Show Academic Performance</div>
                        <div class="setting-description">Display your performance charts to teachers</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="showPerformance" checked>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Allow Contact from Teachers</div>
                        <div class="setting-description">Teachers can send you direct messages through the system</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="allowTeacherContact" checked>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-user-cog me-2"></i> Account Settings
            </div>
            <div class="card-body p-0">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Two-Factor Authentication</div>
                        <div class="setting-description">Add an extra layer of security to your account</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="twoFactorAuth">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Login Notifications</div>
                        <div class="setting-description">Get notified when someone logs into your account from a new device</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="loginNotifications" checked>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Session Timeout</div>
                        <div class="setting-description">Automatically log out after 30 minutes of inactivity</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="sessionTimeout" checked>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display Settings -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-palette me-2"></i> Display Settings
            </div>
            <div class="card-body p-0">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Theme</div>
                        <div class="setting-description">Choose your preferred color theme</div>
                    </div>
                    <div class="setting-value">
                        <select class="form-select form-select-sm" id="themeSelect" style="width: auto;">
                            <option value="light" selected>Light</option>
                            <option value="dark">Dark</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Font Size</div>
                        <div class="setting-description">Adjust the text size for better readability</div>
                    </div>
                    <div class="setting-value">
                        <select class="form-select form-select-sm" id="fontSizeSelect" style="width: auto;">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Sidebar Position</div>
                        <div class="setting-description">Choose where the sidebar appears</div>
                    </div>
                    <div class="setting-value">
                        <select class="form-select form-select-sm" id="sidebarPosition" style="width: auto;">
                            <option value="left" selected>Left</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4">
        <!-- Save Settings -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-save me-2"></i> Save Settings
            </div>
            <div class="card-body text-center">
                <p class="text-muted mb-4">Your settings will be applied immediately after saving</p>
                <button class="btn save-btn" id="saveSettingsBtn">
                    <i class="fas fa-save me-2"></i> Save All Changes
                </button>
                <p class="text-muted small mt-3">Last saved: <span id="lastSavedTime">Never</span></p>
            </div>
        </div>

        <!-- Reset to Default -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-undo me-2"></i> Reset Settings
            </div>
            <div class="card-body text-center">
                <p class="text-muted mb-4">This will reset all your settings to their default values</p>
                <button class="btn btn-outline-danger" id="resetSettingsBtn">
                    <i class="fas fa-undo me-2"></i> Reset to Default
                </button>
            </div>
        </div>

        <!-- Account Actions -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-shield-alt me-2"></i> Account Security
            </div>
            <div class="card-body p-0">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Change Password</div>
                        <div class="setting-description">Update your login password</div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="changePassword()">Change</button>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Login History</div>
                        <div class="setting-description">View recent login activity</div>
                    </div>
                    <button class="btn btn-outline-info btn-sm" onclick="viewLoginHistory()">View</button>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Connected Devices</div>
                        <div class="setting-description">Manage devices logged into your account</div>
                    </div>
                    <button class="btn btn-outline-warning btn-sm" onclick="manageDevices()">Manage</button>
                </div>
            </div>
        </div>

        <!-- Data Management -->
        <div class="card settings-card">
            <div class="card-header">
                <i class="fas fa-database me-2"></i> Data Management
            </div>
            <div class="card-body p-0">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Export Data</div>
                        <div class="setting-description">Download all your data in a portable format</div>
                    </div>
                    <button class="btn btn-outline-success btn-sm" onclick="exportData()">Export</button>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Clear Cache</div>
                        <div class="setting-description">Remove temporary files and data</div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearCache()">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize settings from localStorage
        function loadSettings() {
            // Load notification settings
            document.getElementById('emailNotifications').checked = 
                localStorage.getItem('emailNotifications') !== 'false';
            document.getElementById('gradeAlerts').checked = 
                localStorage.getItem('gradeAlerts') !== 'false';
            document.getElementById('assignmentReminders').checked = 
                localStorage.getItem('assignmentReminders') !== 'false';
            document.getElementById('reportCardAlerts').checked = 
                localStorage.getItem('reportCardAlerts') !== 'false';
            
            // Load privacy settings
            document.getElementById('showProfile').checked = 
                localStorage.getItem('showProfile') !== 'false';
            document.getElementById('showPerformance').checked = 
                localStorage.getItem('showPerformance') !== 'false';
            document.getElementById('allowTeacherContact').checked = 
                localStorage.getItem('allowTeacherContact') !== 'false';
            
            // Load account settings
            document.getElementById('twoFactorAuth').checked = 
                localStorage.getItem('twoFactorAuth') === 'true';
            document.getElementById('loginNotifications').checked = 
                localStorage.getItem('loginNotifications') !== 'false';
            document.getElementById('sessionTimeout').checked = 
                localStorage.getItem('sessionTimeout') !== 'false';
            
            // Load display settings
            const theme = localStorage.getItem('theme') || 'light';
            document.getElementById('themeSelect').value = theme;
            
            const fontSize = localStorage.getItem('fontSize') || 'medium';
            document.getElementById('fontSizeSelect').value = fontSize;
            
            const sidebarPos = localStorage.getItem('sidebarPosition') || 'left';
            document.getElementById('sidebarPosition').value = sidebarPos;
            
            // Load last saved time
            const lastSaved = localStorage.getItem('lastSavedTime');
            if (lastSaved) {
                document.getElementById('lastSavedTime').textContent = lastSaved;
            }
        }
        
        // Save all settings
        function saveSettings() {
            // Save notification settings
            localStorage.setItem('emailNotifications', 
                document.getElementById('emailNotifications').checked);
            localStorage.setItem('gradeAlerts', 
                document.getElementById('gradeAlerts').checked);
            localStorage.setItem('assignmentReminders', 
                document.getElementById('assignmentReminders').checked);
            localStorage.setItem('reportCardAlerts', 
                document.getElementById('reportCardAlerts').checked);
            
            // Save privacy settings
            localStorage.setItem('showProfile', 
                document.getElementById('showProfile').checked);
            localStorage.setItem('showPerformance', 
                document.getElementById('showPerformance').checked);
            localStorage.setItem('allowTeacherContact', 
                document.getElementById('allowTeacherContact').checked);
            
            // Save account settings
            localStorage.setItem('twoFactorAuth', 
                document.getElementById('twoFactorAuth').checked);
            localStorage.setItem('loginNotifications', 
                document.getElementById('loginNotifications').checked);
            localStorage.setItem('sessionTimeout', 
                document.getElementById('sessionTimeout').checked);
            
            // Save display settings
            localStorage.setItem('theme', 
                document.getElementById('themeSelect').value);
            localStorage.setItem('fontSize', 
                document.getElementById('fontSizeSelect').value);
            localStorage.setItem('sidebarPosition', 
                document.getElementById('sidebarPosition').value);
            
            // Update last saved time
            const now = new Date().toLocaleString();
            localStorage.setItem('lastSavedTime', now);
            document.getElementById('lastSavedTime').textContent = now;
            
            // Show success message
            showToast('Settings saved successfully!', 'success');
            
            // Apply theme changes immediately
            applyTheme();
        }
        
        // Apply theme changes
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
            } else if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.body.classList.remove('dark-theme');
            } else {
                // Auto theme - check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('light-theme');
                } else {
                    document.body.classList.add('light-theme');
                    document.body.classList.remove('dark-theme');
                }
            }
            
            // Apply font size
            const fontSize = localStorage.getItem('fontSize') || 'medium';
            document.body.style.fontSize = fontSize === 'small' ? '14px' : 
                                          fontSize === 'large' ? '18px' : '16px';
        }
        
        // Reset to default settings
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default? This cannot be undone.')) {
                localStorage.clear();
                loadSettings();
                applyTheme();
                showToast('Settings reset to default!', 'info');
            }
        }
        
        // Show toast notification
        function showToast(message, type) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.settings-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show settings-toast position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Account action functions
        function changePassword() {
            alert('Password change functionality would open here. In a real application, this would open a modal or new page for changing the password.');
        }
        
        function viewLoginHistory() {
            alert('Login history would be displayed here. This would show recent login attempts and locations.');
        }
        
        function manageDevices() {
            alert('Device management would open here. This would allow you to view and revoke access from logged-in devices.');
        }
        
        function exportData() {
            alert('Data export would begin here. This would download all your data in JSON or CSV format.');
        }
        
        function clearCache() {
            if (confirm('Clear all cached data? This may improve performance but will require reloading some data.')) {
                // Clear session storage and indexedDB if used
                sessionStorage.clear();
                showToast('Cache cleared successfully!', 'success');
            }
        }
        
        // Initialize
        loadSettings();
        applyTheme();
        
        // Event listeners
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        document.getElementById('resetSettingsBtn').addEventListener('click', resetSettings);
        
        // Auto-save on theme change
        document.getElementById('themeSelect').addEventListener('change', function() {
            localStorage.setItem('theme', this.value);
            applyTheme();
        });
        
        document.getElementById('fontSizeSelect').addEventListener('change', function() {
            localStorage.setItem('fontSize', this.value);
            applyTheme();
        });
        
        document.getElementById('sidebarPosition').addEventListener('change', function() {
            localStorage.setItem('sidebarPosition', this.value);
            showToast('Sidebar position will update on next page load.', 'info');
        });
        
        // Listen for system theme changes for auto theme mode
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            if (localStorage.getItem('theme') === 'auto') {
                applyTheme();
            }
        });
    });
</script>
{% endblock %}