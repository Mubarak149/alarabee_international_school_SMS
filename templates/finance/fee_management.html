{% extends "finance/base_finance.html" %}
{% block title %}Fee Management - Finance{% endblock %}

{% block extra_css %}
    <style>
        /* ===== GRID LAYOUT STYLES ===== */
        .class-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
                margin-bottom: 30px;
            }
        
        .class-grid-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e5e9;
            overflow: hidden;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .class-grid-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: #4CAF50;
        }
        
        .class-card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .class-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .class-card-subtitle {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
        }
        
        .term-section-grid {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }
        
        .term-section-grid:last-child {
            border-bottom: none;
        }
        
        .term-section-grid:hover {
            background-color: #f8f9fa;
        }
        
        .term-header-grid {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .term-title-grid {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .fees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .fee-item-grid {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .fee-item-grid:hover {
            border-color: #4CAF50;
            background-color: #f8fff9;
        }
        
        .fee-name-grid {
            font-size: 0.85rem;
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .fee-amount-grid {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4CAF50;
            font-family: monospace;
        }
        
        .term-actions-grid {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .term-total-grid {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 6px;
            padding: 10px 15px;
            margin-top: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .term-total-label {
            font-size: 0.85rem;
            color: #2e7d32;
            font-weight: 500;
        }
        
        .term-total-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1b5e20;
            font-family: monospace;
        }
        
        .card-actions-grid {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e1e5e9;
            margin-top: auto;
        }
        
        .action-buttons-grid {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        .btn-grid-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
            flex: 1;
        }
        
        /* Term Badges */
        .term-badge-grid {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .term-1-grid { background-color: #e3f2fd; color: #1565c0; }
        .term-2-grid { background-color: #e8f5e9; color: #2e7d32; }
        .term-3-grid { background-color: #fff3e0; color: #ef6c00; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .class-grid-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .fees-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons-grid {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-grid-sm {
                width: 100%;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .class-grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1>Fee Management</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'finance_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Fee Management</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <button class="btn btn-finance-primary" data-bs-toggle="modal" data-bs-target="#addFeeStructureModal">
                <i class="fas fa-plus me-1"></i> Add Fee Structure
            </button>
            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addFeeTypeModal">
                <i class="fas fa-tag me-1"></i> Add Fee Type
            </button>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="finance-card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">
            <i class="fas fa-filter me-2"></i> Filter Fee Structure
        </h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label">Class</label>
                <select name="class" class="form-select">
                    <option value="all" {% if class_filter == 'all' %}selected{% endif %}>All Classes</option>
                    {% for class in classes %}
                        <option value="{{ class.id }}" {% if class_filter|stringformat:"s" == class.id|stringformat:"s" %}selected{% endif %}>
                            {{ class.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-12 col-md-3">
                <label class="form-label">Academic Year</label>
                <select name="academic_year" class="form-select">
                    <option value="all" {% if academic_year_filter == 'all' %}selected{% endif %}>All Years</option>
                    {% for year in academic_years %}
                        <option value="{{ year.id }}" {% if academic_year_filter|stringformat:"s" == year.id|stringformat:"s" %}selected{% endif %}>
                            {{ year.year }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-12 col-md-3">
                <label class="form-label">Term</label>
                <select name="term" class="form-select">
                    <option value="all" {% if term_filter == 'all' %}selected{% endif %}>All Terms</option>
                    {% for term in terms %}
                        <option value="{{ term.id }}" {% if term_filter|stringformat:"s" == term.id|stringformat:"s" %}selected{% endif %}>
                            {{ term.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-12 col-md-3">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-finance-primary flex-fill">
                        <i class="fas fa-search me-1"></i> Apply Filter
                    </button>
                    <a href="{% url 'fee_management' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- GRID LAYOUT - Fee Structure by Class -->
{% if grouped_fees %}
<div class="class-grid-container">
    {% for key, fees in grouped_fees.items %}
    <div class="class-grid-card">
        <!-- Class Header -->
        <div class="class-card-header">
            <h3 class="class-card-title">{{ key.0 }}</h3>
            <p class="class-card-subtitle">
                {{ key.1 }} • {{ fees|length }} fee items
            </p>
        </div>
        
        <!-- Group fees by term -->
        {% regroup fees by term as term_fees %}
        {% for term_group in term_fees %}
        <div class="term-section-grid">
            <!-- Term Header -->
            <div class="term-header-grid">
                <div class="term-title-grid">
                    <span class="term-badge-grid term-{{ term_group.grouper.id|default:'1' }}-grid">
                        {{ term_group.grouper.name }}
                    </span>
                    <span>({{ term_group.list|length }} items)</span>
                </div>
                
                <div class="term-actions-grid">
                    <button class="btn btn-outline-success btn-sm btn-grid-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#generateTermInvoicesModal{{ term_group.grouper.id }}{{ forloop.parentloop.counter }}"
                            title="Generate {{ term_group.grouper.name }} invoices">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Generate
                    </button>
                    <button class="btn btn-outline-primary btn-sm btn-grid-sm"
                            onclick="window.location.href='{% url 'term_invoices' class_id=fees.0.school_class.id term_id=term_group.grouper.id academic_year_id=fees.0.academic_year.id %}'"
                            title="View {{ term_group.grouper.name }} invoices">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                </div>
            </div>
            
            <!-- Fee Items Grid -->
            <div class="fees-grid">
                {% for fee_structure in term_group.list %}
                <div class="fee-item-grid" 
                     onclick="showFeeDetails('{{ fee_structure.id }}')"
                     style="cursor: pointer;"
                     data-bs-toggle="tooltip"
                     title="Click to edit {{ fee_structure.fee_type.name }} - ₦{{ fee_structure.amount|floatformat:2 }}">
                    <div class="fee-name-grid">
                        {{ fee_structure.fee_type.name|truncatechars:15 }}
                    </div>
                    <div class="fee-amount-grid">
                        ₦{{ fee_structure.amount|floatformat:2 }}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Term Total -->
            <div class="term-total-grid">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="term-total-label">Term Total:</span>
                    <span class="term-total-amount">
                        ₦{% with total=0 %}
                            {% for fee_structure in term_group.list %}
                                {% with total=total|add:fee_structure.amount %}
                                {% endwith %}
                            {% endfor %}
                            {{ total|floatformat:2 }}
                        {% endwith %}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Card Actions -->
        <div class="card-actions-grid">
            <div class="action-buttons-grid">
                <button class="btn btn-success btn-sm btn-grid-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#generateAllInvoicesModal{{ forloop.counter }}">
                    <i class="fas fa-file-invoice-dollar me-1"></i>
                    Generate All
                </button>
                <button class="btn btn-outline-primary btn-sm btn-grid-sm"
                        onclick="viewClassInvoices('{{ key.0 }}', '{{ key.1 }}')">
                    <i class="fas fa-list me-1"></i>
                    View All Invoices
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== MODALS FOR THIS CLASS ===== -->
    
    <!-- Generate All Term Invoices Modal -->
    <div class="modal fade" id="generateAllInvoicesModal{{ forloop.counter }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form method="post" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="action" value="generate_all_invoices">
                <input type="hidden" name="school_class_id" value="{{ fees.0.school_class.id }}">
                <input type="hidden" name="academic_year_id" value="{{ fees.0.academic_year.id }}">

                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        Generate All Term Invoices
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Generate invoices for all terms in <strong>{{ key.0 }}</strong> - {{ fees.0.academic_year.year }}
                    </div>
                    
                    <!-- Term Summary -->
                    <div class="mb-3">
                        <h6>Terms to Generate:</h6>
                        {% regroup fees by term as all_term_fees %}
                        {% for term_group in all_term_fees %}
                            <div class="alert alert-secondary mb-2">
                                <strong>{{ term_group.grouper.name }}</strong>: 
                                {{ term_group.list|length }} fee items
                                <span class="float-end">Total: 
                                    {% with total=0 %}
                                        {% for fee_structure in term_group.list %}
                                            {% with total=total|add:fee_structure.amount %}
                                            {% endwith %}
                                        {% endfor %}
                                        ₦{{ total|floatformat:2 }}
                                    {% endwith %}
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Students Info -->
                    <div class="mb-3">
                        <h6>Affected Students:</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-users me-2"></i>
                            <strong>Note:</strong> All students in {{ key.0 }} will receive invoices for each term
                        </div>
                    </div>
                    
                    <!-- Options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="skip_existing" id="skipAllExisting{{ forloop.counter }}" checked>
                            <label class="form-check-label" for="skipAllExisting{{ forloop.counter }}">
                                Skip students who already have invoices
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="apply_sponsorship" id="applyAllSponsorship{{ forloop.counter }}" checked>
                            <label class="form-check-label" for="applyAllSponsorship{{ forloop.counter }}">
                                Apply sponsorship discounts automatically
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="generate_by_term" id="generateByTerm{{ forloop.counter }}" checked>
                            <label class="form-check-label" for="generateByTerm{{ forloop.counter }}">
                                Generate separate invoices for each term
                            </label>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar me-1"></i>
                        Generate All Invoices
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Generate Term Invoices Modals -->
    {% regroup fees by term as all_term_fees %}
    {% for term_group in all_term_fees %}
        <div class="modal fade" id="generateTermInvoicesModal{{ term_group.grouper.id }}{{ forloop.parentloop.counter }}" tabindex="-1">
            <div class="modal-dialog">
                <form method="post" class="modal-content">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generate_invoice">
                    <input type="hidden" name="school_class_id" value="{{ fees.0.school_class.id }}">
                    <input type="hidden" name="academic_year_id" value="{{ fees.0.academic_year.id }}">
                    <input type="hidden" name="term_id" value="{{ term_group.grouper.id }}">

                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-file-invoice-dollar me-2"></i>
                            Generate {{ term_group.grouper.name }} Invoices
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Generate all fee invoices for <strong>{{ key.0 }}</strong> 
                            in <strong>{{ term_group.grouper.name }}</strong> - {{ fees.0.academic_year.year }}
                        </div>
                        
                        <!-- Fee Summary -->
                        <div class="mb-3">
                            <h6>Fee Items for {{ term_group.grouper.name }}:</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fee Type</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fee_structure in term_group.list %}
                                    <tr>
                                        <td>{{ fee_structure.fee_type.name }}</td>
                                        <td>₦{{ fee_structure.amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-success">
                                        <td><strong>Total:</strong></td>
                                        <td><strong>
                                            {% with total=0 %}
                                                {% for fee_structure in term_group.list %}
                                                    {% with total=total|add:fee_structure.amount %}
                                                    {% endwith %}
                                                {% endfor %}
                                                ₦{{ total|floatformat:2 }}
                                            {% endwith %}
                                        </strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Students Info -->
                        <div class="mb-3">
                            <h6>Affected Students:</h6>
                            <div class="alert alert-warning">
                                <i class="fas fa-users me-2"></i>
                                All students in {{ key.0 }} will receive these invoices
                            </div>
                        </div>
                        
                        <!-- Options -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="skip_existing" id="skipTermExisting{{ term_group.grouper.id }}{{ forloop.parentloop.counter }}" checked>
                                <label class="form-check-label" for="skipTermExisting{{ term_group.grouper.id }}{{ forloop.parentloop.counter }}">
                                    Skip students who already have invoices for this term
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="apply_sponsorship" id="applyTermSponsorship{{ term_group.grouper.id }}{{ forloop.parentloop.counter }}" checked>
                                <label class="form-check-label" for="applyTermSponsorship{{ term_group.grouper.id }}{{ forloop.parentloop.counter }}">
                                    Apply sponsorship discounts automatically
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-file-invoice-dollar me-1"></i>
                            Generate Term Invoices
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% endfor %}
    
    <!-- Individual Fee Structure Modals -->
    {% for fee_structure in fees %}
    <!-- Edit Fee Structure Modal -->
    <div class="modal fade" id="editFeeStructureModal{{ fee_structure.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form method="post" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_fee_structure">
                <input type="hidden" name="fee_structure_id" value="{{ fee_structure.id }}">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Edit Fee Structure</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">Fee Type *</label>
                            <select name="fee_type" class="form-select" required>
                                <option value="">Select Fee Type</option>
                                {% for fee_type in fee_types %}
                                <option value="{{ fee_type.id }}" 
                                    {% if fee_type.id == fee_structure.fee_type.id %}selected{% endif %}>
                                    {{ fee_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Class *</label>
                            <select name="school_class" class="form-select" required>
                                <option value="">Select Class</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}" 
                                    {% if class.id == fee_structure.school_class.id %}selected{% endif %}>
                                    {{ class.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Academic Year *</label>
                            <select name="academic_year" class="form-select" required>
                                <option value="">Select Academic Year</option>
                                {% for year in academic_years %}
                                <option value="{{ year.id }}" 
                                    {% if year.id == fee_structure.academic_year.id %}selected{% endif %}>
                                    {{ year.year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Term *</label>
                            <select name="term" class="form-select" required>
                                <option value="">Select Term</option>
                                {% for term in terms %}
                                <option value="{{ term.id }}" 
                                    {% if term.id == fee_structure.term.id %}selected{% endif %}>
                                    {{ term.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">₦</span>
                                <input type="number" class="form-control" name="amount" 
                                       value="{{ fee_structure.amount }}" 
                                       step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Fee Structure Modal -->
    <div class="modal fade" id="deleteFeeStructureModal{{ fee_structure.id }}" tabindex="-1">
        <div class="modal-dialog">
            <form method="post" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_fee_structure">
                <input type="hidden" name="fee_structure_id" value="{{ fee_structure.id }}">

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete Fee Structure</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>Are you sure?</h5>
                    <p class="text-muted">
                        Delete fee structure for:
                        <strong>{{ fee_structure.fee_type.name }}</strong>?
                    </p>
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-circle me-1"></i>
                            This action cannot be undone.
                        </small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
    {% endfor %}
    <!-- END OF CLASS MODALS -->
    
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-money-bill-wave fa-4x text-muted mb-3"></i>
    <h4>No Fee Structure Found</h4>
    <p class="text-muted">
        {% if class_filter != 'all' %}
            No fee structure defined for selected filters
        {% else %}
            No fee structure has been defined yet
        </p>
        <button class="btn btn-finance-primary mt-3" data-bs-toggle="modal" data-bs-target="#addFeeStructureModal">
            <i class="fas fa-plus me-1"></i> Create Fee Structure
        </button>
    {% endif %}
</div>
{% endif %}

<!-- ===== GLOBAL MODALS ===== -->

<!-- Add Fee Structure Modal -->
<div class="modal fade" id="addFeeStructureModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-finance-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Add New Fee Structure
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_fee_structure">

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">Fee Type *</label>
                            {{ fee_structure_form.fee_type }}
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Class *</label>
                            {{ fee_structure_form.school_class }}
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Academic Year *</label>
                            {{ fee_structure_form.academic_year }}
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Term *</label>
                            {{ fee_structure_form.term }}
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">₦</span>
                                {{ fee_structure_form.amount }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-finance-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Fee Type Modal -->
<div class="modal fade" id="addFeeTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="post" class="modal-content">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_fee_type">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i> Add Fee Type
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" name="name" required
                           placeholder="e.g., Tuition Fee, Hostel Fee, Exam Fee">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3"
                              placeholder="Optional description of this fee type"></textarea>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="is_recurring" id="is_recurring_new" checked>
                    <label class="form-check-label" for="is_recurring_new">
                        Recurring Fee (charged every term)
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Add Fee Type</button>
            </div>
        </form>
    </div>
</div>

<!-- View Existing Fee Types Modal -->
{% if fee_types %}
<div class="modal fade" id="viewFeeTypesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-tags me-2"></i> Available Fee Types
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    {% for fee_type in fee_types %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">{{ fee_type.name }}</h6>
                                {% if fee_type.description %}
                                <p class="card-text text-muted small">{{ fee_type.description }}</p>
                                {% endif %}
                                <span class="badge {% if fee_type.is_recurring %}bg-info{% else %}bg-secondary{% endif %}">
                                    {{ fee_type.is_recurring|yesno:"Recurring,One-time" }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFeeTypeModal">
                    <i class="fas fa-plus me-1"></i> Add New
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Format all amounts on the page
        document.querySelectorAll('.fee-amount-grid, .term-total-amount').forEach(element => {
            const text = element.textContent;
            const amount = parseFloat(text.replace(/[^0-9.-]+/g, ''));
            if (!isNaN(amount)) {
                element.textContent = '₦' + amount.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        });
        
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Add tooltips to fee items
        document.querySelectorAll('.fee-item-grid').forEach(item => {
            new bootstrap.Tooltip(item);
        });
        
        // Calculate actual term totals
        calculateTermTotals();
    });
    
    // View term invoices
    function viewTermInvoices(className, termName, academicYear) {
        // This would redirect to a filtered invoice list page
        // For now, show a modal or alert
        alert(`Viewing invoices for ${className} - ${termName} - ${academicYear}\n\nIn production, this would redirect to a filtered invoice list.`);
        // In production: window.location.href = `/finance/invoices/?class=${encodeURIComponent(className)}&term=${encodeURIComponent(termName)}&year=${encodeURIComponent(academicYear)}`;
    }
    
    // View class invoices
    function viewClassInvoices(className, academicYear) {
        alert(`Viewing all invoices for ${className} - ${academicYear}\n\nIn production, this would redirect to a filtered invoice list by class.`);
        // In production: window.location.href = `/finance/invoices/?class=${encodeURIComponent(className)}&year=${encodeURIComponent(academicYear)}`;
    }
    
    // Show fee details (opens edit modal)
    function showFeeDetails(feeStructureId) {
        const editModal = document.getElementById(`editFeeStructureModal${feeStructureId}`);
        if (editModal) {
            const modal = new bootstrap.Modal(editModal);
            modal.show();
        } else {
            alert('Edit modal not found for this fee structure.');
        }
    }
    
    // Calculate term totals
    function calculateTermTotals() {
        document.querySelectorAll('.term-section-grid').forEach(termSection => {
            const feeItems = termSection.querySelectorAll('.fee-amount-grid');
            let total = 0;
            
            feeItems.forEach(item => {
                const amountText = item.textContent;
                const amount = parseFloat(amountText.replace(/[^0-9.-]+/g, ''));
                if (!isNaN(amount)) {
                    total += amount;
                }
            });
            
            const totalElement = termSection.querySelector('.term-total-amount');
            if (totalElement) {
                totalElement.textContent = '₦' + total.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        });
    }
    
    // Export to CSV
    function exportFeeStructure() {
        let csvContent = "Class,Academic Year,Term,Fee Type,Amount\n";
        
        document.querySelectorAll('.class-grid-card').forEach(card => {
            const className = card.querySelector('.class-card-title').textContent.trim();
            const academicYear = card.querySelector('.class-card-subtitle').textContent.split('•')[0].trim();
            
            card.querySelectorAll('.term-section-grid').forEach(termSection => {
                const termName = termSection.querySelector('.term-badge-grid').textContent.trim();
                
                termSection.querySelectorAll('.fee-item-grid').forEach(feeItem => {
                    const feeName = feeItem.querySelector('.fee-name-grid').textContent.trim();
                    const feeAmount = feeItem.querySelector('.fee-amount-grid').textContent.trim();
                    
                    csvContent += `"${className}","${academicYear}","${termName}","${feeName}","${feeAmount}"\n`;
                });
            });
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `fee_structure_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        alert('Fee structure exported to CSV successfully!');
    }
</script>
{% endblock %}