{% extends "teacher/base_teacher.html" %}
{% load static %}

{% block title %}Manage Scores - School SMS{% endblock %}

{% block extra_css %}
    <style>
        /* Custom styles for manage scores */
        .score-management-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .selection-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4e73df;
        }
        
        .upload-section {
            background: #fff;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #4e73df;
            background: #f8f9ff;
        }
        
        .score-input-table {
            margin-top: 20px;
        }
        
        .score-input-table table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .score-input-table th {
            background: #4e73df;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .score-input-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .score-input-table tr:hover {
            background: #f8f9ff;
        }
        
        .score-input {
            width: 100px;
            padding: 5px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
        }
        
        .score-input:focus {
            border-color: #4e73df;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
            outline: none;
        }
        
        .score-input.invalid {
            border-color: #e74a3b;
            background: #fff5f5;
        }
        
        .score-input.valid {
            border-color: #1cc88a;
            background: #f0fff8;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #4e73df;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .student-name {
            font-weight: 500;
        }
        
        .student-admission {
            font-size: 12px;
            color: #6c757d;
        }
        
        .bulk-upload-options {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .score-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .score-status.saved {
            background: #d1f7e5;
            color: #0a8154;
        }
        
        .score-status.unsaved {
            background: #ffeaea;
            color: #e74a3b;
        }
        
        .score-status.pending {
            background: #fff4e6;
            color: #f39c12;
        }
        
        .score-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            opacity: 0.9;
        }
        
        .summary-value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .quick-action-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
            display: block;
            cursor: pointer;
        }
        
        .quick-action-card:hover {
            border-color: #4e73df;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .quick-action-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(78, 115, 223, 0.1);
            color: #4e73df;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .score-management-container {
                padding: 15px;
            }
            
            .selection-card {
                padding: 15px;
            }
            
            .score-input {
                width: 80px;
            }
            
            .student-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Manage Student Scores</h1>
            <div class="d-flex gap-2">
                <a href="{% url 'view_scores' %}" class="btn btn-outline-primary">
                    <i class="fas fa-eye me-2"></i> View Scores
                </a>
            </div>
        </div>
        <div class="breadcrumb">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'teacher_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Manage Scores</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-grid mb-4">
        <div class="quick-action-card" onclick="showManualEntry()">
            <div class="icon">
                <i class="fas fa-edit"></i>
            </div>
            <div class="action-title">Manual Entry</div>
            <div class="action-description">Enter scores one by one</div>
        </div>
        
        <div class="quick-action-card" onclick="showBulkUpload()">
            <div class="icon">
                <i class="fas fa-file-upload"></i>
            </div>
            <div class="action-title">Bulk Upload</div>
            <div class="action-description">Upload Excel/CSV file</div>
        </div>
        
        <div class="quick-action-card" onclick="downloadTemplate()">
            <div class="icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="action-title">Download Template</div>
            <div class="action-description">Get Excel template</div>
        </div>
        
        <a href="{% url 'view_scores' %}" class="quick-action-card">
            <div class="icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="action-title">Search Scores</div>
            <div class="action-description">Find and edit scores</div>
        </a>
    </div>

    <div class="score-management-container">
        <!-- Selection Criteria -->
        <div class="selection-card" id="selectionCard">
            <h5 class="mb-3"><i class="fas fa-filter me-2"></i> Select Criteria</h5>
            <form id="selectionForm">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="academicSession" class="form-label">Academic Session *</label>
                        <select class="form-select" id="academicSession" required>
                            <option value="">Select Session</option>
                            {% for session in academic_sessions %}
                                <option value="{{ session.id }}" {% if session.is_current %}selected{% endif %}>
                                    {{ session.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="term" class="form-label">Term *</label>
                        <select class="form-select" id="term" required>
                            <option value="">Select Term</option>
                            {% for term in terms %}
                                <option value="{{ term.id }}">{{ term.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="scoreType" class="form-label">Score Type *</label>
                        <select class="form-select" id="scoreType" required>
                            <option value="">Select Type</option>
                            {% for score_type in score_types %}
                                <option value="{{ score_type.id }}">{{ score_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="subject" class="form-label">Subject *</label>
                        <select class="form-select" id="subject" required>
                            <option value="">Select Subject</option>
                            {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="classSelect" class="form-label">Class *</label>
                        <select class="form-select" id="classSelect" required>
                            <option value="">Select Class</option>
                            {% for class in teacher_classes %}
                                <option value="{{ class.id }}">{{ class.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" onclick="loadStudents()">
                            <i class="fas fa-users me-2"></i> Load Students
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Score Summary -->
        <div class="score-summary" id="scoreSummary" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Score Summary</h5>
                <span id="summaryStatus" class="score-status pending">Not Saved</span>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="summary-item">
                        <span class="summary-label">Total Students</span>
                        <span class="summary-value" id="totalStudents">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-item">
                        <span class="summary-label">Scores Entered</span>
                        <span class="summary-value" id="scoresEntered">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-item">
                        <span class="summary-label">Average Score</span>
                        <span class="summary-value" id="averageScore">0.00</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-item">
                        <span class="summary-label">Highest Score</span>
                        <span class="summary-value" id="highestScore">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Section -->
        <div id="manualEntrySection" style="display: none;">
            <div class="upload-section">
                <i class="fas fa-edit fa-3x text-primary mb-3"></i>
                <h5>Manual Score Entry</h5>
                <p class="text-muted">Enter scores for each student below. Click "Save All Scores" when done.</p>
            </div>
            
            <!-- Score Input Table -->
            <div class="score-input-table" id="scoreInputTable">
                <!-- Table will be populated by JavaScript -->
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button type="button" class="btn btn-outline-secondary" onclick="resetScores()">
                    <i class="fas fa-redo me-2"></i> Reset
                </button>
                <button type="button" class="btn btn-success" onclick="saveAllScores()">
                    <i class="fas fa-save me-2"></i> Save All Scores
                </button>
            </div>
        </div>

        <!-- Bulk Upload Section -->
        <div id="bulkUploadSection" style="display: none;">
            <div class="upload-section" id="dropZone">
                <i class="fas fa-file-upload fa-3x text-success mb-3"></i>
                <h5>Bulk Upload Scores</h5>
                <p class="text-muted">Select your Excel/CSV file to upload scores in bulk</p>
                <form id="bulkUploadForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="academic_session" id="bulkAcademicSession">
                    <input type="hidden" name="term" id="bulkTerm">
                    <input type="hidden" name="score_type" id="bulkScoreType">
                    <input type="hidden" name="subject" id="bulkSubject">
                    <input type="hidden" name="class" id="bulkClass">
                    
                    <input type="file" id="bulkUploadFile" name="score_file" accept=".xlsx,.xls,.csv" class="form-control mt-3">
                    <div class="mt-3">
                        <small class="text-muted">Supported formats: .xlsx, .xls, .csv</small>
                    </div>
                    <button type="button" class="btn btn-success mt-3" onclick="processBulkUpload()">
                        <i class="fas fa-upload me-2"></i> Upload File
                    </button>
                </form>
            </div>
            
            <!-- Progress Container -->
            <div class="progress-container" id="progressContainer">
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                        role="progressbar" id="uploadProgress" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center"></div>
                <div id="uploadResults" class="mt-3"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Global variables
        let students = [];
        let scoresData = {};
        let unsavedChanges = false;
        let currentClassId = null;
        let currentSubjectId = null;
        let currentTermId = null;
        let currentScoreTypeId = null;
        let currentAcademicSessionId = null;

        // Show manual entry section
        function showManualEntry() {
            document.getElementById('manualEntrySection').style.display = 'block';
            document.getElementById('bulkUploadSection').style.display = 'none';
            document.getElementById('scoreSummary').style.display = 'block';
        }

        // Show bulk upload section
        function showBulkUpload() {
            document.getElementById('manualEntrySection').style.display = 'none';
            document.getElementById('bulkUploadSection').style.display = 'block';
            document.getElementById('scoreSummary').style.display = 'none';
            
            // Populate hidden fields with current selections
            const academicSession = document.getElementById('academicSession').value;
            const term = document.getElementById('term').value;
            const scoreType = document.getElementById('scoreType').value;
            const subject = document.getElementById('subject').value;
            const classSelect = document.getElementById('classSelect').value;
            
            document.getElementById('bulkAcademicSession').value = academicSession;
            document.getElementById('bulkTerm').value = term;
            document.getElementById('bulkScoreType').value = scoreType;
            document.getElementById('bulkSubject').value = subject;
            document.getElementById('bulkClass').value = classSelect;
        }

        // Download template
        function downloadTemplate() {
            showToast('Template download would start here', 'info');
            // In a real implementation, this would trigger a file download
            // window.location.href = '/download-score-template/';
        }

        // Load students based on selection
        function loadStudents() {
            const classId = document.getElementById('classSelect').value;
            const subjectId = document.getElementById('subject').value;
            const termId = document.getElementById('term').value;
            const scoreTypeId = document.getElementById('scoreType').value;
            const academicSessionId = document.getElementById('academicSession').value;
            
            if (!classId || !subjectId || !termId || !scoreTypeId || !academicSessionId) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            // Store current selections
            currentClassId = classId;
            currentSubjectId = subjectId;
            currentTermId = termId;
            currentScoreTypeId = scoreTypeId;
            currentAcademicSessionId = academicSessionId;
            
            // In a real implementation, this would fetch students from the server
            // For now, we'll use dummy data
            showLoading(true);
            
            setTimeout(() => {
                // Dummy student data - replace with actual API call
                students = [
                    { id: 1, name: 'John Doe', admission_number: 'STU001', roll_number: '1' },
                    { id: 2, name: 'Jane Smith', admission_number: 'STU002', roll_number: '2' },
                    { id: 3, name: 'Bob Johnson', admission_number: 'STU003', roll_number: '3' },
                    { id: 4, name: 'Alice Brown', admission_number: 'STU004', roll_number: '4' },
                    { id: 5, name: 'Charlie Wilson', admission_number: 'STU005', roll_number: '5' },
                ];
                
                // Dummy existing scores - replace with actual API call
                scoresData = {
                    1: { score_id: 101, score: 85.5, updated_at: '2023-10-15' },
                    3: { score_id: 103, score: 92.0, updated_at: '2023-10-15' },
                };
                
                renderScoreTable();
                updateSummary();
                showManualEntry();
                document.getElementById('actionButtons').style.display = 'flex';
                showToast(`Loaded ${students.length} students`, 'success');
                showLoading(false);
            }, 1000);
        }

        // Render score input table
        function renderScoreTable() {
            const tableContainer = document.getElementById('scoreInputTable');
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="50">#</th>
                                <th>Student</th>
                                <th width="150">Admission No.</th>
                                <th width="150">Score (0-100)</th>
                                <th width="100">Status</th>
                                <th width="100">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            students.forEach((student, index) => {
                const existingScore = scoresData[student.id];
                const scoreValue = existingScore ? existingScore.score : '';
                const status = existingScore ? 'saved' : 'unsaved';
                const lastUpdated = existingScore ? existingScore.updated_at : '-';
                
                // Get initials for avatar
                const initials = student.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div>
                                    <div class="student-name">${student.name}</div>
                                    <div class="student-admission">Roll: ${student.roll_number || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${student.admission_number}</td>
                        <td>
                            <input type="number" 
                                class="score-input ${status}" 
                                value="${scoreValue}" 
                                min="0" 
                                max="100" 
                                step="0.01"
                                data-student-id="${student.id}"
                                onchange="updateScore(this, ${student.id})"
                                oninput="validateScore(this)"
                                placeholder="Enter score">
                        </td>
                        <td>
                            <span class="score-status ${status}">
                                <i class="fas fa-${status === 'saved' ? 'check' : 'exclamation'} me-1"></i>
                                ${status === 'saved' ? 'Saved' : 'Unsaved'}
                            </span>
                        </td>
                        <td><small class="text-muted">${lastUpdated}</small></td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>`;
            tableContainer.innerHTML = html;
        }

        // Validate score input
        function validateScore(input) {
            const value = parseFloat(input.value);
            input.classList.remove('valid', 'invalid');
            
            if (input.value === '') {
                return true; // Allow empty
            }
            
            if (isNaN(value)) {
                input.classList.add('invalid');
                return false;
            }
            
            if (value < 0 || value > 100) {
                input.classList.add('invalid');
                return false;
            }
            
            input.classList.add('valid');
            return true;
        }

        // Update score in local data
        function updateScore(input, studentId) {
            if (!validateScore(input)) {
                showToast('Please enter a valid score between 0 and 100', 'warning');
                return;
            }
            
            const scoreValue = input.value === '' ? null : parseFloat(input.value);
            
            if (!scoresData[studentId]) {
                scoresData[studentId] = {};
            }
            
            scoresData[studentId].score = scoreValue;
            scoresData[studentId].isNew = !scoresData[studentId].score_id;
            
            // Update status
            const row = input.closest('tr');
            const statusCell = row.querySelector('.score-status');
            if (scoreValue !== null) {
                statusCell.className = 'score-status pending';
                statusCell.innerHTML = '<i class="fas fa-clock me-1"></i> Pending';
            } else {
                statusCell.className = 'score-status unsaved';
                statusCell.innerHTML = '<i class="fas fa-exclamation me-1"></i> Unsaved';
            }
            
            unsavedChanges = true;
            updateSummary();
        }

        // Update summary statistics
        function updateSummary() {
            let total = 0;
            let count = 0;
            let highest = 0;
            
            Object.values(scoresData).forEach(scoreData => {
                if (scoreData.score !== null && scoreData.score !== undefined) {
                    const score = parseFloat(scoreData.score);
                    total += score;
                    count++;
                    highest = Math.max(highest, score);
                }
            });
            
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('scoresEntered').textContent = count;
            document.getElementById('averageScore').textContent = count > 0 ? (total / count).toFixed(2) : '0.00';
            document.getElementById('highestScore').textContent = highest > 0 ? highest.toFixed(2) : '0.00';
            
            // Update status
            const statusElement = document.getElementById('summaryStatus');
            if (unsavedChanges) {
                statusElement.className = 'score-status pending';
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> Unsaved Changes';
            } else if (count === students.length) {
                statusElement.className = 'score-status saved';
                statusElement.innerHTML = '<i class="fas fa-check me-1"></i> All Saved';
            } else {
                statusElement.className = 'score-status unsaved';
                statusElement.innerHTML = '<i class="fas fa-times me-1"></i> Incomplete';
            }
        }

        // Save all scores
        function saveAllScores() {
            // Collect scores to save
            const scoresToSave = [];
            
            students.forEach(student => {
                const scoreData = scoresData[student.id];
                if (scoreData && scoreData.score !== undefined && scoreData.score !== null) {
                    scoresToSave.push({
                        student_id: student.id,
                        score: scoreData.score
                    });
                }
            });
            
            if (scoresToSave.length === 0) {
                showToast('No scores to save', 'warning');
                return;
            }
            
            showLoading(true);
            
            // In a real implementation, this would send data to the server
            // For now, we'll simulate a successful save
            setTimeout(() => {
                showToast(`Successfully saved ${scoresToSave.length} scores`, 'success');
                unsavedChanges = false;
                
                // Update UI to show saved status
                scoresToSave.forEach(score => {
                    const studentId = score.student_id;
                    if (scoresData[studentId]) {
                        scoresData[studentId].isNew = false;
                        scoresData[studentId].updated_at = new Date().toLocaleDateString();
                    }
                });
                
                // Refresh table to show updated status
                renderScoreTable();
                updateSummary();
                showLoading(false);
            }, 1500);
        }

        // Reset scores
        function resetScores() {
            if (!unsavedChanges) {
                return;
            }
            
            if (confirm('Are you sure you want to reset all unsaved changes?')) {
                scoresData = {};
                renderScoreTable();
                updateSummary();
                showToast('All changes reset', 'info');
            }
        }

        // Process bulk upload
        function processBulkUpload() {
            const fileInput = document.getElementById('bulkUploadFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a file first', 'warning');
                return;
            }
            
            // Validate required fields
            const academicSession = document.getElementById('bulkAcademicSession').value;
            const term = document.getElementById('bulkTerm').value;
            const scoreType = document.getElementById('bulkScoreType').value;
            const subject = document.getElementById('bulkSubject').value;
            const classSelect = document.getElementById('bulkClass').value;
            
            if (!academicSession || !term || !scoreType || !subject || !classSelect) {
                showToast('Please select all criteria before uploading', 'warning');
                return;
            }
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('uploadProgress').style.width = '30%';
            document.getElementById('progressText').innerHTML = 'Uploading file...';
            
            // Simulate upload progress
            setTimeout(() => {
                document.getElementById('uploadProgress').style.width = '70%';
                document.getElementById('progressText').innerHTML = 'Processing scores...';
                
                setTimeout(() => {
                    document.getElementById('uploadProgress').style.width = '100%';
                    document.getElementById('progressText').innerHTML = 
                        '<span class="text-success"><i class="fas fa-check-circle me-2"></i>Upload Complete!</span>';
                    
                    // Show results
                    document.getElementById('uploadResults').innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>Bulk Upload Successful</h6>
                            <p>Successfully uploaded ${file.name}</p>
                            <ul class="mb-0">
                                <li><strong>File:</strong> ${file.name}</li>
                                <li><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</li>
                                <li><strong>Scores processed:</strong> 25</li>
                            </ul>
                        </div>`;
                    
                    // Reset form
                    document.getElementById('bulkUploadForm').reset();
                    
                }, 1500);
            }, 1000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveAllScores();
            }
            
            // Esc to reset
            if (e.key === 'Escape') {
                resetScores();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Show warning before leaving unsaved changes
            window.addEventListener('beforeunload', function(e) {
                if (unsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                    return 'You have unsaved changes. Are you sure you want to leave?';
                }
            });
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
{% endblock %}